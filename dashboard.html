<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>Dashboard - Fórmula DS3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--text:#f9fafb;--muted:#9ca3af}
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
    body{min-height:100vh;background:radial-gradient(circle at top,#1f2937,#020617);color:var(--text)}
    header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(2,6,23,0.95);border-bottom:1px solid rgba(148,163,184,0.35)}
    nav a{font-size:13px;color:#93c5fd;text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid rgba(147,197,253,0.7)}
    main{max-width:1100px;margin:18px auto;padding:12px}
    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card{background:radial-gradient(circle at top,#020617,#030712);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.08)}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px dashed rgba(75,85,99,0.6);text-align:left}
    @media(max-width:900px){.cards{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:8px;overflow:hidden;background:#fff;padding:4px"><img src="logo-fds3.png" style="width:36px" alt="logo"></div><div><strong>Fórmula DS3</strong><br><span style="font-size:12px;color:var(--muted)" id="infoUser"></span></div></div>
  <nav><a href="dashboard.html">Dashboard</a><a href="recepcao.html">Recepção</a><a href="consulta_entradas.html">Consultar</a><a href="admin.html">Admin</a><a href="corrida.html">Corrida</a><a href="index.html" id="logoutBtn">Sair</a></nav>
</header>

<main>
  <h2>Painel em tempo real</h2>

  <div class="cards" style="margin-top:12px">
    <div class="card"><small style="color:var(--muted)">Total participantes</small><div id="totalParticipantes" style="font-size:22px;font-weight:700;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Palpites Carro 1</small><div id="palpites1" style="font-weight:700;font-size:20px;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Palpites Carro 2</small><div id="palpites2" style="font-weight:700;font-size:20px;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Palpites Carro 3</small><div id="palpites3" style="font-weight:700;font-size:20px;margin-top:8px">0</div></div>

    <div class="card"><small style="color:var(--muted)">Visitantes</small><div id="countVisitante" style="font-weight:700;font-size:18px;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Avaliadores</small><div id="countAvaliador" style="font-weight:700;font-size:18px;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Categoria ADS</small><div id="countADS" style="font-weight:700;font-size:18px;margin-top:8px">0</div></div>
    <div class="card"><small style="color:var(--muted)">Outras categorias</small><div id="countOutras" style="font-weight:700;font-size:18px;margin-top:8px">0</div></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3>Últimas entradas</h3>
    <table><thead><tr><th>Nome</th><th>Série</th><th>Turma</th><th>Tipo</th><th>Categoria</th><th>Carro</th><th>Data</th></tr></thead>
    <tbody id="tbodyUltimas"></tbody></table>
  </div>
</main>

<script type="module">
/* ACCESS-BLOCK */
const ALLOWED_ROLES = ["admin","master","recepcao","corrida"];
const infoUserEl = document.getElementById("infoUser"), logoutBtn = document.getElementById("logoutBtn");
function getUser(){ try{return JSON.parse(localStorage.getItem("usuarioLogado"))}catch(e){return null} }
function showAccessBlocked(message){
  document.querySelectorAll("button,input,select,textarea").forEach(el=>el.disabled=true);
  if(logoutBtn) logoutBtn.disabled=true;
  if(document.getElementById("accessBlockedCard")) return;
  const card=document.createElement("div"); card.id="accessBlockedCard"; Object.assign(card.style,{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(90deg, rgba(2,6,23,0.8), rgba(2,6,23,0.95))",zIndex:"9999"});
  const inner=document.createElement("div"); Object.assign(inner.style,{maxWidth:"720px",width:"92%",borderRadius:"14px",padding:"22px",boxShadow:"0 20px 40px rgba(0,0,0,0.7)",background:"linear-gradient(135deg,#0b1220,#021024)",color:"var(--text)",textAlign:"center"});
  const title=document.createElement("h2"); title.textContent="Acesso bloqueado"; title.style.color="#fca5a5";
  const p=document.createElement("p"); p.textContent = message || "Solicite ao administrador alteração de perfil."; p.style.color="var(--muted)";
  const btn=document.createElement("button"); btn.textContent="Solicitar alteração ao administrador"; Object.assign(btn.style,{padding:"10px 16px",borderRadius:"999px",border:"none",cursor:"pointer",background:"linear-gradient(135deg,#f97316,#ef4444)",color:"#fff",fontWeight:"700"}); btn.onclick = ()=> window.location.href = "mailto:rh@empresa.com.br?subject=Solicitação%20de%20alteração%20de%20perfil&body=Por%20favor%20alterar%20meu%20perfil.%20Email:%20" + encodeURIComponent(getUser()?.email || "");
  inner.appendChild(title); inner.appendChild(p); inner.appendChild(btn); card.appendChild(inner); document.body.appendChild(card);
}
(function checkAccess(){ const u = getUser(); if(!u){ showAccessBlocked("Faça login para acessar esta página."); infoUserEl.textContent=""; return } if(!ALLOWED_ROLES.includes(u.role)){ showAccessBlocked("Acesso bloqueado — solicite ao administrador alteração de perfil."); infoUserEl.textContent = `Logado como: ${u.email} (${u.role})`; return } infoUserEl.textContent = `Logado como: ${u.email}` })();
if(logoutBtn) logoutBtn.addEventListener("click", ()=>{ localStorage.removeItem("usuarioLogado"); setTimeout(()=>window.location.href="index.html",50); });

/* firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
  authDomain: "eeba-9dfd0.firebaseapp.com",
  databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
  projectId: "eeba-9dfd0",
  storageBucket: "eeba-9dfd0.firebasestorage.app",
  messagingSenderId: "947616785928",
  appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const apostasRef = ref(db, "apostas");

const totalParticipantesEl = document.getElementById("totalParticipantes");
const p1 = document.getElementById("palpites1"), p2 = document.getElementById("palpites2"), p3 = document.getElementById("palpites3");
const countVisitante = document.getElementById("countVisitante"), countAvaliador=document.getElementById("countAvaliador");
const countADS=document.getElementById("countADS"), countOutras=document.getElementById("countOutras");
const tbodyUltimas = document.getElementById("tbodyUltimas");

onValue(apostasRef, (snapshot)=>{
  let total=0, c1=0,c2=0,c3=0, visit=0, aval=0, ads=0, outras=0;
  const lista=[];
  if(snapshot.exists()){
    snapshot.forEach(ch=>{
      const v = ch.val();
      lista.push(v);
      total++;
      if(v.carro === "carro1") c1++;
      if(v.carro === "carro2") c2++;
      if(v.carro === "carro3") c3++;
      if(v.tipo === "Visitante") visit++; else if(v.tipo === "Avaliador") aval++;
      if(v.categoria === "ADS") ads++; else if(v.categoria) outras++;
    });
  }
  totalParticipantesEl.textContent = total;
  p1.textContent = c1; p2.textContent = c2; p3.textContent = c3;
  countVisitante.textContent = visit; countAvaliador.textContent = aval;
  countADS.textContent = ads; countOutras.textContent = outras;

  // últimas 10
  tbodyUltimas.innerHTML = "";
  const ult = lista.slice(-10).reverse();
  ult.forEach(v=>{
    const tr = document.createElement("tr");
    const s = v.dataHora ? new Date(v.dataHora).toLocaleString() : "";
    tr.innerHTML = `<td>${v.nome||""}</td><td>${v.serie||""}</td><td>${v.turma||""}</td><td>${v.tipo||""}</td><td>${v.categoria||""}</td><td>${v.carro||""}</td><td>${s}</td>`;
    tbodyUltimas.appendChild(tr);
  });
});
</script>
</body>
</html>
