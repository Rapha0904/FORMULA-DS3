<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin - Gestão de Acessos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{--bg:#020617;--card:#020617;--text:#f9fafb;--muted:#9ca3af;--accent:#ef4444;--accent-soft:#f97316}
        *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
        body{min-height:100vh;background:radial-gradient(circle at top,#1f2937,#020617);color:var(--text);padding-top:64px;}
        header{position:fixed;top:0;left:0;right:0;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid rgba(148,163,184,0.35);background:rgba(2,6,23,0.95);backdrop-filter:blur(6px);z-index:50}
        .brand{display:flex;align-items:center;gap:10px}
        .logo-circle{width:48px;height:48px;border-radius:8px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
        .logo-circle img{width:36px}
        .brand strong{font-size:15px}
        .brand span{font-size:11px;color:var(--muted);text-transform:uppercase}
        .navwrap{display:flex;align-items:center;gap:8px}
        nav{display:flex;align-items:center;gap:8px}
        nav a{font-size:12px;color:#93c5fd;text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid rgba(147,197,253,0.7)}
        .menu-toggle{display:none;border:none;background:transparent;color:var(--text);font-size:20px;padding:8px;border-radius:8px}
        .user-info{font-size:12px;color:var(--muted)}
        main{max-width:1100px;margin:16px auto;padding:12px}
        .grid{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,1.4fr);gap:16px}
        @media(max-width:900px){ .grid{grid-template-columns:1fr} }
        .card{background:radial-gradient(circle at top,#020617,#020617 40%,#030712);border-radius:20px;padding:16px 16px 20px;border:1px solid rgba(148,163,184,0.45);box-shadow:0 20px 40px rgba(0,0,0,0.75)}
        .tag{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
        h2{font-size:18px}
        .description{font-size:12px;color:var(--muted);margin-top:4px}
        .form-group{margin-top:10px;display:flex;flex-direction:column;gap:5px;font-size:13px}
        input, select{padding:8px 10px;border-radius:11px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.9);color:var(--text);font-size:13px}
        .btn{margin-top:14px;padding:9px 18px;border-radius:999px;border:none;background:linear-gradient(135deg,#f97316,#ef4444);color:white;font-size:13px;font-weight:600;cursor:pointer}
        .btn-secondary{margin-left:8px;background:transparent;border:1px solid rgba(148,163,184,0.8)}
        .users-list{margin-top:8px;max-height:360px;overflow:auto;padding-right:4px}
        .users-header, .user-row{display:grid;grid-template-columns:1.2fr 1.4fr 0.8fr 0.7fr;gap:8px;font-size:12px;align-items:center}
        @media(max-width:600px){ .users-header, .user-row{grid-template-columns:1.4fr 1.4fr 0.9fr;grid-template-rows:auto auto} .users-header span:last-child, .user-row span:last-child{grid-column:1 / -1} }
        .badge-role{padding:2px 8px;border-radius:999px;font-size:11px;text-transform:uppercase;letter-spacing:.5px}
        .role-recepcao{background:rgba(34,197,94,0.15);color:#bbf7d0}
        .role-corrida{background:rgba(59,130,246,0.15);color:#bfdbfe}
        .role-admin{background:rgba(249,115,22,0.15);color:#fed7aa}
        .btn-small{padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,0.8);background:transparent;color:#e5e7eb;font-size:11px;cursor:pointer;margin-right:4px;margin-top:2px}
        .btn-small.btn-del{border-color:rgba(248,113,113,0.9);color:#fecaca}
        .empty{margin-top:10px;font-size:12px;color:var(--muted)}

        /* mobile nav behavior */
        @media(max-width:900px){
            nav{position:fixed;top:64px;right:12px;background:linear-gradient(180deg, rgba(2,6,23,0.98), rgba(2,6,23,0.95));padding:12px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.6);display:none;flex-direction:column;gap:8px;z-index:60}
            nav.open{display:flex}
            .menu-toggle{display:inline-flex}
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="logo-circle"><img src="logo-fds3.png" alt="FDS3"></div>
        <div>
            <strong>Fórmula DS3</strong><br>
            <span>Admin • Gestão de acessos</span>
        </div>
    </div>

    <div class="navwrap">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">☰</button>
        <nav id="mainNav">
            <span class="user-info" id="infoUser"></span>
            <a href="recepcao.html">Recepção</a>
            <a href="corrida.html">Corrida</a>
            <a href="index.html" id="logoutLink">Sair</a>
        </nav>
    </div>
</header>

<main>
    <div class="grid">
        <section class="card">
            <div class="card-header">
                <span class="tag">Novo acesso / Edição</span>
                <h2>Gerenciar usuários do sistema</h2>
                <p class="description">Crie e edite logins para a equipe: recepção, controle da corrida e outros administradores.</p>
            </div>

            <form id="formUsuario">
                <div class="form-group">
                    <label for="nome">Nome</label>
                    <input id="nome" type="text" placeholder="Ex: João da Recepção" required>
                </div>
                <div class="form-group">
                    <label for="email">E-mail de acesso</label>
                    <input id="email" type="email" placeholder="email@escola.pr.gov.br" required>
                </div>
                <div class="form-group">
                    <label for="senha">Senha de acesso</label>
                    <input id="senha" type="password" placeholder="Senha para este usuário" required>
                </div>
                <div class="form-group">
                    <label for="role">Função / Permissão</label>
                    <select id="role" required>
                        <option value="">Selecione...</option>
                        <option value="recepcao">Recepção (cadastro + palpite)</option>
                        <option value="corrida">Corrida (start da corrida)</option>
                        <option value="admin">Admin (acesso a todas as telas)</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="btnSalvar">Salvar acesso</button>
                <button type="button" class="btn btn-secondary" id="btnCancelar" style="display:none;">Cancelar edição</button>
                <div id="msgCadastro"></div>
            </form>
        </section>

        <section class="card">
            <div class="card-header">
                <span class="tag">Usuários cadastrados</span>
                <h2>Contas de acesso ativas</h2>
                <p class="description">Estes usuários conseguem entrar pelo login. O master é fixo no código e não aparece aqui.</p>
            </div>

            <div class="users-list" id="listaUsuarios"></div>
        </section>
    </div>
</main>

<script type="module">
    // NAV hamburger
    const menuToggle = document.getElementById('menuToggle');
    const mainNav = document.getElementById('mainNav');
    menuToggle.addEventListener('click', ()=> mainNav.classList.toggle('open'));
    document.addEventListener('click', (e)=>{
        if(window.innerWidth <= 900 && !e.target.closest('header')) mainNav.classList.remove('open');
    });

    // access check (master/admin)
    const userData = localStorage.getItem("usuarioLogado");
    if(!userData){
        // show overlay instead of redirect
        alert("Faça login primeiro.");
        window.location.href = "index.html";
    }else{
        const u = JSON.parse(userData);
        if(u.role !== "master" && u.role !== "admin"){
            alert("Apenas administradores podem acessar esta página.");
            window.location.href = "index.html";
        }else{
            const info = u.role === "master" ? "(MASTER)" : "(ADMIN)";
            document.getElementById("infoUser").textContent = `Logado como: ${u.email} ${info}`;
        }
    }

    // logout link
    const logoutLink = document.getElementById("logoutLink");
    logoutLink.addEventListener("click", ()=> { localStorage.removeItem("usuarioLogado"); });

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
      authDomain: "eeba-9dfd0.firebaseapp.com",
      databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
      projectId: "eeba-9dfd0",
      storageBucket: "eeba-9dfd0.firebasestorage.app",
      messagingSenderId: "947616785928",
      appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const usuariosRef = ref(db,"usuarios");

    const formUsuario  = document.getElementById("formUsuario");
    const msgCadastro  = document.getElementById("msgCadastro");
    const listaUsuarios = document.getElementById("listaUsuarios");
    const btnSalvar    = document.getElementById("btnSalvar");
    const btnCancelar  = document.getElementById("btnCancelar");

    let chaveEditando = null;

    function limparFormulario(){
        formUsuario.reset();
        chaveEditando = null;
        btnSalvar.textContent = "Salvar acesso";
        btnCancelar.style.display = "none";
    }

    formUsuario.addEventListener("submit", async (e)=>{
        e.preventDefault();
        msgCadastro.textContent = "";
        msgCadastro.className = "";

        const nome  = document.getElementById("nome").value.trim();
        const email = document.getElementById("email").value.trim();
        const senha = document.getElementById("senha").value.trim();
        const role  = document.getElementById("role").value;

        if(!nome || !email || !senha || !role){
            msgCadastro.textContent = "Preencha todos os campos.";
            msgCadastro.className = "erro";
            return;
        }

        const usuario = { nome, email, senha, role };

        try{
            if(chaveEditando){
                await set(ref(db,"usuarios/"+chaveEditando), usuario);
                msgCadastro.textContent = "Usuário atualizado com sucesso!";
            }else{
                await push(usuariosRef, usuario);
                msgCadastro.textContent = "Usuário cadastrado com sucesso!";
            }
            msgCadastro.className = "ok";
            limparFormulario();
        }catch(err){
            console.error(err);
            msgCadastro.textContent = "Erro ao salvar usuário no Firebase.";
            msgCadastro.className = "erro";
        }
    });

    btnCancelar.addEventListener("click", ()=>{
        limparFormulario();
        msgCadastro.textContent = "";
        msgCadastro.className = "";
    });

    onValue(usuariosRef,(snapshot)=>{
        listaUsuarios.innerHTML = "";
        if(!snapshot.exists()){
            listaUsuarios.innerHTML = "<p class='empty'>Nenhum usuário cadastrado ainda.</p>";
            return;
        }

        const header = document.createElement("div");
        header.className = "users-header";
        header.innerHTML = "<span>Nome</span><span>E-mail</span><span>Função</span><span>Ações</span>";
        listaUsuarios.appendChild(header);

        snapshot.forEach(child=>{
            const key = child.key;
            const u   = child.val();

            const row = document.createElement("div");
            row.className = "user-row";

            const spanNome  = document.createElement("span");
            const spanEmail = document.createElement("span");
            const spanRole  = document.createElement("span");
            const spanAcoes = document.createElement("span");

            spanNome.textContent  = u.nome || "(sem nome)";
            spanEmail.textContent = u.email;

            const badge = document.createElement("span");
            badge.className = "badge-role ";
            if(u.role === "recepcao") badge.className += "role-recepcao";
            else if(u.role === "corrida") badge.className += "role-corrida";
            else badge.className += "role-admin";
            badge.textContent = u.role;

            spanRole.appendChild(badge);

            const btnEdit = document.createElement("button");
            btnEdit.className = "btn-small";
            btnEdit.textContent = "Editar";
            btnEdit.onclick = ()=>{
                document.getElementById("nome").value  = u.nome || "";
                document.getElementById("email").value = u.email || "";
                document.getElementById("senha").value = u.senha || "";
                document.getElementById("role").value  = u.role || "";
                chaveEditando = key;
                btnSalvar.textContent = "Salvar alterações";
                btnCancelar.style.display = "inline-block";
                msgCadastro.textContent = `Editando usuário: ${u.nome}`;
                msgCadastro.className = "";
            };

            const btnDel = document.createElement("button");
            btnDel.className = "btn-small btn-del";
            btnDel.textContent = "Excluir";
            btnDel.onclick = async ()=>{
                if(confirm(`Remover o acesso de ${u.nome}?`)){
                    await remove(ref(db, "usuarios/" + key));
                    if(chaveEditando === key) limparFormulario();
                }
            };

            spanAcoes.appendChild(btnEdit);
            spanAcoes.appendChild(btnDel);

            row.appendChild(spanNome);
            row.appendChild(spanEmail);
            row.appendChild(spanRole);
            row.appendChild(spanAcoes);

            listaUsuarios.appendChild(row);
        });
    });
</script>
</body>
</html>
