<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin - Gestão de Acessos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --bg:#020617;
            --card:#020617;
            --text:#f9fafb;
            --muted:#9ca3af;
            --accent:#ef4444;
            --accent-soft:#f97316;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
        body{
            min-height:100vh;
            background:radial-gradient(circle at top,#1f2937,#020617);
            color:var(--text);
        }
        header{
            padding:12px 22px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:1px solid rgba(148,163,184,0.35);
            background:rgba(2,6,23,0.95);
            backdrop-filter:blur(10px);
        }
        .logo-area{
            display:flex;align-items:center;gap:10px;
        }
        .logo-circle{
            width:52px;height:52px;border-radius:50%;
            background:#020617;border:2px solid var(--accent);
            display:flex;align-items:center;justify-content:center;
            overflow:hidden;box-shadow:0 0 10px rgba(239,68,68,0.5);
        }
        .logo-circle img{width:65px;}
        .logo-text{display:flex;flex-direction:column;gap:2px;}
        .logo-text strong{font-size:16px;}
        .logo-text span{font-size:11px;color:var(--muted);text-transform:uppercase;}
        nav{
            display:flex;align-items:center;gap:8px;
        }
        nav a{
            font-size:12px;color:#93c5fd;text-decoration:none;
            padding:4px 10px;border-radius:999px;
            border:1px solid rgba(147,197,253,0.7);
        }
        nav a:hover{background:rgba(37,99,235,0.2);}
        .user-info{font-size:11px;color:var(--muted);}
        main{
            max-width:1000px;margin:20px auto;padding:0 18px 30px;
        }
        .grid{
            display:grid;
            grid-template-columns:minmax(0,1.2fr) minmax(0,1.6fr);
            gap:18px;
        }
        @media(max-width:950px){.grid{grid-template-columns:1fr;}}
        .card{
            background:radial-gradient(circle at top,#020617,#020617 40%,#030712);
            border-radius:22px;
            padding:18px 20px 22px;
            border:1px solid rgba(148,163,184,0.45);
            box-shadow:0 22px 40px rgba(0,0,0,0.75);
        }
        .card-header{margin-bottom:10px;}
        .tag{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
        h2{font-size:18px;}
        .description{font-size:12px;color:var(--muted);margin-top:4px;}
        .form-group{margin-top:10px;display:flex;flex-direction:column;gap:5px;font-size:13px;}
        label{color:var(--muted);font-weight:500;}
        input, select{
            padding:8px 10px;border-radius:11px;
            border:1px solid rgba(148,163,184,0.7);
            background:rgba(15,23,42,0.9);
            color:var(--text);font-size:13px;
            transition:border .15s, box-shadow .15s, background .15s;
        }
        input::placeholder{color:#6b7280;}
        input:focus, select:focus{
            outline:none;
            border-color:var(--accent-soft);
            box-shadow:0 0 0 1px rgba(249,115,22,0.7);
            background:#020617;
        }
        select{
            appearance:none;
            -webkit-appearance:none;
            -moz-appearance:none;
            background-image:
                linear-gradient(45deg, transparent 50%, #f97316 50%),
                linear-gradient(135deg, #f97316 50%, transparent 50%);
            background-position:
                calc(100% - 16px) calc(50% - 3px),
                calc(100% - 10px) calc(50% - 3px);
            background-size:6px 6px;
            background-repeat:no-repeat;
        }
        .btn{
            margin-top:14px;
            padding:9px 18px;border-radius:999px;border:none;
            background:linear-gradient(135deg,#f97316,#ef4444);
            color:white;font-size:13px;font-weight:600;
            text-transform:uppercase;letter-spacing:.6px;cursor:pointer;
            box-shadow:0 14px 28px rgba(248,113,113,0.55);
        }
        .btn:hover{transform:translateY(-1px);}
        .btn-secondary{
            margin-left:8px;
            background:transparent;
            border:1px solid rgba(148,163,184,0.8);
            box-shadow:none;
        }
        #msgCadastro{margin-top:8px;font-size:12px;}
        .ok{color:#4ade80;}
        .erro{color:#fca5a5;}

        /* Lista de usuários */
        .users-list{margin-top:8px;}
        .users-header, .user-row{
            display:grid;
            grid-template-columns:1.2fr 1.4fr 0.8fr 0.7fr;
            gap:8px;
            font-size:12px;
            align-items:center;
        }
        .users-header{
            padding-bottom:6px;
            border-bottom:1px solid rgba(75,85,99,0.9);
            color:var(--muted);
            text-transform:uppercase;
            letter-spacing:.8px;
        }
        .user-row{
            padding:6px 0;
            border-bottom:1px dashed rgba(55,65,81,0.8);
        }
        .badge-role{
            padding:2px 8px;border-radius:999px;font-size:11px;
            text-transform:uppercase;letter-spacing:.5px;
        }
        .role-recepcao{background:rgba(34,197,94,0.15);color:#bbf7d0;}
        .role-corrida{background:rgba(59,130,246,0.15);color:#bfdbfe;}
        .role-admin{background:rgba(249,115,22,0.15);color:#fed7aa;}
        .btn-small{
            padding:4px 8px;border-radius:999px;border:1px solid rgba(148,163,184,0.8);
            background:transparent;color:#e5e7eb;font-size:11px;cursor:pointer;
            margin-right:4px;
        }
        .btn-small.btn-del{border-color:rgba(248,113,113,0.9);color:#fecaca;}
        .btn-small:hover{background:rgba(148,163,184,0.15);}
        .btn-small.btn-del:hover{background:rgba(248,113,113,0.15);}
        .empty{
            margin-top:10px;font-size:12px;color:var(--muted);
        }
    </style>
</head>
<body>
<header>
    <div class="logo-area">
        <div class="logo-circle">
            <img src="logo-fds3.png" alt="FDS3">
        </div>
        <div class="logo-text">
            <strong>Fórmula DS3</strong>
            <span>Admin • Gestão de acessos</span>
        </div>
    </div>
    <nav>
        <span class="user-info" id="infoUser"></span>
        <a href="recepcao.html">Recepção</a>
        <a href="corrida.html">Corrida</a>
        <a href="index.html" onclick="localStorage.removeItem('usuarioLogado')">Sair</a>
    </nav>
</header>

<main>
    <div class="grid">
        <!-- CADASTRO / EDIÇÃO DE USUÁRIO -->
        <section class="card">
            <div class="card-header">
                <span class="tag">Novo acesso / Edição</span>
                <h2>Gerenciar usuário do sistema</h2>
                <p class="description">
                    Use este formulário para criar novos acessos ou editar os já existentes (e-mail, senha e função).
                </p>
            </div>

            <form id="formUsuario">
                <div class="form-group">
                    <label for="nome">Nome</label>
                    <input id="nome" type="text" placeholder="Ex: João da Recepção" required>
                </div>
                <div class="form-group">
                    <label for="email">E-mail de acesso</label>
                    <input id="email" type="email" placeholder="email@escola.pr.gov.br" required>
                </div>
                <div class="form-group">
                    <label for="senha">Senha de acesso</label>
                    <input id="senha" type="password" placeholder="Senha para este usuário" required>
                </div>
                <div class="form-group">
                    <label for="role">Função / Permissão</label>
                    <select id="role" required>
                        <option value="">Selecione...</option>
                        <option value="recepcao">Recepção (cadastro + aposta)</option>
                        <option value="corrida">Corrida (start da corrida)</option>
                        <option value="admin">Admin (pode usar esta tela)</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="btnSalvar">Salvar acesso</button>
                <button type="button" class="btn btn-secondary" id="btnCancelar" style="display:none;">Cancelar edição</button>
                <div id="msgCadastro"></div>
            </form>
        </section>

        <!-- LISTA DE USUÁRIOS -->
        <section class="card">
            <div class="card-header">
                <span class="tag">Usuários cadastrados</span>
                <h2>Contas de acesso ativas</h2>
                <p class="description">
                    Esses usuários conseguem entrar pelo login. O master (você) é fixo e não aparece aqui.
                </p>
            </div>

            <div class="users-list" id="listaUsuarios"></div>
        </section>
    </div>
</main>

<script type="module">
    // Proteção: só master ou admin
    const userData = localStorage.getItem("usuarioLogado");
    if(!userData){
        alert("Faça login primeiro.");
        window.location.href = "login.html";
    }else{
        const u = JSON.parse(userData);
        if(u.role !== "master" && u.role !== "admin"){
            alert("Você não tem acesso à área de admin.");
            window.location.href = "login.html";
        }else{
            document.getElementById("infoUser").textContent =
                u.role === "master"
                    ? `Logado como: ${u.email} (MASTER)`
                    : `Logado como: ${u.email} (ADMIN)`;
        }
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
      authDomain: "eeba-9dfd0.firebaseapp.com",
      databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
      projectId: "eeba-9dfd0",
      storageBucket: "eeba-9dfd0.firebasestorage.app",
      messagingSenderId: "947616785928",
      appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const usuariosRef = ref(db,"usuarios");

    const formUsuario  = document.getElementById("formUsuario");
    const msgCadastro  = document.getElementById("msgCadastro");
    const listaUsuarios = document.getElementById("listaUsuarios");
    const btnSalvar    = document.getElementById("btnSalvar");
    const btnCancelar  = document.getElementById("btnCancelar");

    // guarda a chave do usuário que está sendo editado (se houver)
    let chaveEditando = null;

    function limparFormulario(){
        formUsuario.reset();
        chaveEditando = null;
        btnSalvar.textContent = "Salvar acesso";
        btnCancelar.style.display = "none";
    }

    formUsuario.addEventListener("submit", async (e)=>{
        e.preventDefault();
        msgCadastro.textContent = "";
        msgCadastro.className = "";

        const nome  = document.getElementById("nome").value.trim();
        const email = document.getElementById("email").value.trim();
        const senha = document.getElementById("senha").value.trim();
        const role  = document.getElementById("role").value;

        if(!nome || !email || !senha || !role){
            msgCadastro.textContent = "Preencha todos os campos.";
            msgCadastro.className = "erro";
            return;
        }

        const usuario = { nome, email, senha, role };

        try{
            if(chaveEditando){
                // atualização
                await set(ref(db,"usuarios/"+chaveEditando), usuario);
                msgCadastro.textContent = "Usuário atualizado com sucesso!";
            }else{
                // criação
                await push(usuariosRef, usuario);
                msgCadastro.textContent = "Usuário cadastrado com sucesso!";
            }
            msgCadastro.className = "ok";
            limparFormulario();
        }catch(err){
            console.error(err);
            msgCadastro.textContent = "Erro ao salvar usuário no Firebase.";
            msgCadastro.className = "erro";
        }
    });

    btnCancelar.addEventListener("click", ()=>{
        limparFormulario();
        msgCadastro.textContent = "";
        msgCadastro.className = "";
    });

    // Monta a lista de usuários em tempo real
    onValue(usuariosRef,(snapshot)=>{
        listaUsuarios.innerHTML = "";
        if(!snapshot.exists()){
            listaUsuarios.innerHTML = "<p class='empty'>Nenhum usuário cadastrado ainda.</p>";
            return;
        }

        const header = document.createElement("div");
        header.className = "users-header";
        header.innerHTML = "<span>Nome</span><span>E-mail</span><span>Função</span><span>Ações</span>";
        listaUsuarios.appendChild(header);

        snapshot.forEach(child=>{
            const key = child.key;
            const u   = child.val();

            const row = document.createElement("div");
            row.className = "user-row";

            const spanNome  = document.createElement("span");
            const spanEmail = document.createElement("span");
            const spanRole  = document.createElement("span");
            const spanAcoes = document.createElement("span");

            spanNome.textContent  = u.nome || "(sem nome)";
            spanEmail.textContent = u.email;

            const badge = document.createElement("span");
            badge.className = "badge-role ";
            if(u.role === "recepcao") badge.className += "role-recepcao";
            else if(u.role === "corrida") badge.className += "role-corrida";
            else badge.className += "role-admin";
            badge.textContent = u.role;

            spanRole.appendChild(badge);

            const btnEdit = document.createElement("button");
            btnEdit.className = "btn-small";
            btnEdit.textContent = "Editar";
            btnEdit.onclick = ()=>{
                document.getElementById("nome").value  = u.nome || "";
                document.getElementById("email").value = u.email || "";
                document.getElementById("senha").value = u.senha || "";
                document.getElementById("role").value  = u.role || "";
                chaveEditando = key;
                btnSalvar.textContent = "Salvar alterações";
                btnCancelar.style.display = "inline-block";
                msgCadastro.textContent = `Editando usuário: ${u.nome}`;
                msgCadastro.className = "";
            };

            const btnDel = document.createElement("button");
            btnDel.className = "btn-small btn-del";
            btnDel.textContent = "Excluir";
            btnDel.onclick = async ()=>{
                if(confirm(`Remover o acesso de ${u.nome}?`)){
                    await remove(ref(db, "usuarios/" + key));
                    if(chaveEditando === key) limparFormulario();
                }
            };

            spanAcoes.appendChild(btnEdit);
            spanAcoes.appendChild(btnDel);

            row.appendChild(spanNome);
            row.appendChild(spanEmail);
            row.appendChild(spanRole);
            row.appendChild(spanAcoes);

            listaUsuarios.appendChild(row);
        });
    });
</script>
</body>
</html>

