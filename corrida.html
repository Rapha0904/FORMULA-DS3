<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Corrida - F√≥rmula DS3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --bg:#020617;
            --card:#020617;
            --text:#f9fafb;
            --muted:#9ca3af;
            --accent1:#ef4444;
            --accent2:#3b82f6;
            --accent3:#22c55e;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
        body{
            min-height:100vh;
            background:radial-gradient(circle at top,#1f2937,#020617);
            color:var(--text);
        }
        /* HEADER */
        header{
            padding:12px 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            gap:8px;
            border-bottom:1px solid rgba(148,163,184,0.35);
            background:rgba(2,6,23,0.95);
            backdrop-filter:blur(10px);
        }
        .logo-area{
            display:flex;
            align-items:center;
            gap:10px;
        }
        .logo-circle{
            width:48px;height:48px;border-radius:50%;
            background:#020617;border:2px solid var(--accent1);
            display:flex;align-items:center;justify-content:center;
            overflow:hidden;box-shadow:0 0 10px rgba(239,68,68,0.5);
        }
        .logo-circle img{width:60px;}
        .logo-text{display:flex;flex-direction:column;gap:2px;}
        .logo-text strong{font-size:15px;}
        .logo-text span{font-size:11px;color:var(--muted);text-transform:uppercase;}
        nav{
            display:flex;align-items:center;gap:8px;flex-wrap:wrap;
        }
        nav a{
            font-size:12px;color:#93c5fd;text-decoration:none;
            padding:4px 10px;border-radius:999px;
            border:1px solid rgba(147,197,253,0.7);
        }
        nav a:hover{background:rgba(37,99,235,0.2);}
        .user-info{font-size:11px;color:var(--muted);}

        /* MAIN */
        main{
            max-width:1100px;margin:18px auto 26px;padding:0 12px;
        }
        .grid{
            display:grid;
            grid-template-columns:minmax(0,1.7fr) minmax(0,1fr);
            gap:16px;
        }
        @media(max-width:900px){
            .grid{grid-template-columns:1fr;}
        }
        .card{
            background:radial-gradient(circle at top,#020617,#020617 40%,#030712);
            border-radius:20px;
            padding:16px;
            border:1px solid rgba(148,163,184,0.45);
            box-shadow:0 20px 40px rgba(0,0,0,0.75);
        }
        .card-header{
            display:flex;align-items:flex-end;justify-content:space-between;
            margin-bottom:10px;
            gap:8px;
        }
        .tag{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
        h2{font-size:18px;}

        /* CONTROLES */
        .controls{
            display:flex;align-items:center;justify-content:space-between;
            flex-wrap:wrap;gap:10px;margin-bottom:10px;
        }
        .buttons{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .btn{
            padding:9px 18px;border-radius:999px;border:none;
            font-size:13px;font-weight:600;text-transform:uppercase;
            letter-spacing:.6px;cursor:pointer;
        }
        .btn-primary{
            background:linear-gradient(135deg,#f97316,#ef4444);
            color:white;box-shadow:0 12px 25px rgba(248,113,113,0.45);
        }
        .btn-secondary{
            background:#020617;color:var(--muted);
            border:1px solid rgba(148,163,184,0.6);
        }
        .btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none;}
        .btn:hover:not(:disabled){transform:translateY(-1px);}
        .status{font-size:13px;color:var(--muted);}
        .status span{color:#facc15;font-weight:600;}

        /* PISTA VERTICAL */
        .track-wrapper{
            margin-top:8px;
            display:flex;
            justify-content:center;
            gap:12px;
        }
        .track{
            position:relative;
            width:100%;
            max-width:450px;
            height:min(72vh,520px);
            border-radius:18px;
            padding:10px 10px 14px;
            background:conic-gradient(from 180deg,#020617,#020617 40%,#030712 70%,#020617);
            border:1px solid rgba(148,163,184,0.5);
            box-shadow:0 18px 40px rgba(0,0,0,0.8);
            display:flex;
            gap:10px;
        }
        .lane{
            position:relative;
            flex:1;
            border-radius:14px;
            background:linear-gradient(180deg,#020617,#020617 40%,#020617);
            overflow:hidden;
            border:1px solid rgba(148,163,184,0.35);
        }
        .lane::before{
            content:"";
            position:absolute;
            left:50%;top:0;bottom:0;
            width:3px;
            transform:translateX(-50%);
            background:repeating-linear-gradient(
                to bottom,
                rgba(209,213,219,0.7) 0,
                rgba(209,213,219,0.7) 10px,
                transparent 10px,
                transparent 20px
            );
            opacity:.6;
            background-position-y:0;
        }
        .track.running .lane::before{
            animation:dashMove .5s linear infinite;
        }
        @keyframes dashMove{
            0%{background-position-y:0;}
            100%{background-position-y:20px;}
        }
        .finish-bar{
            position:absolute;
            top:12px;
            left:12px;
            right:12px;
            height:6px;
            background:repeating-linear-gradient(
                to right,
                #e5e7eb 0,
                #e5e7eb 10px,
                #020617 10px,
                #020617 20px
            );
            border-radius:10px;
            box-shadow:0 0 12px rgba(248,250,252,0.65);
            z-index:5;
        }

        .car-label{
            position:absolute;
            left:6px;
            bottom:8px;
            font-size:12px;
            display:flex;
            align-items:center;
            gap:4px;
            z-index:2;
            color:var(--muted);
        }
        .car-dot{width:10px;height:10px;border-radius:50%;}
        .car-dot.car1{background:var(--accent1);}
        .car-dot.car2{background:var(--accent2);}
        .car-dot.car3{background:var(--accent3);}

        .car{
            position:absolute;
            left:50%;
            bottom:10px;
            width:120px;
            height:80px;
            transform:translateX(-50%);
            z-index:3;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .car-img{
            width:100%;
            height:auto;
            user-select:none;
            pointer-events:none;
            filter:drop-shadow(0 8px 16px rgba(0,0,0,0.7));
        }
        .car.winner .car-img{
            filter:drop-shadow(0 0 16px rgba(250,204,21,0.9));
        }

        /* Obst√°culos */
        .obstacle{
            position:absolute;
            left:50%;
            width:60%;
            height:10px;
            transform:translateX(-50%);
            border-radius:999px;
            background:rgba(148,163,184,0.6);
            box-shadow:0 4px 10px rgba(15,23,42,0.9);
            z-index:1;
        }
        .obstacle-1{top:170px;}
        .obstacle-2{top:270px;}
        .obstacle-3{top:360px;}

        /* PAINEL LADO DIREITO */
        .mini-grid{
            display:grid;grid-template-columns:repeat(2,minmax(0,1fr));
            gap:10px;margin-top:6px;margin-bottom:12px;
        }
        .pill{
            padding:10px;border-radius:14px;background:#020617;
            border:1px solid rgba(148,163,184,0.5);font-size:12px;
        }
        .pill span{display:block;}
        .pill .value{font-size:17px;font-weight:700;margin-top:2px;}
        .winner-box{
            margin-top:10px;font-size:13px;padding:8px 10px;
            border-radius:10px;background:rgba(15,23,42,0.8);
            border:1px dashed rgba(148,163,184,0.7);min-height:44px;
        }
        .list{margin-top:8px;max-height:190px;overflow:auto;padding-right:4px;}
        .list-item{
            display:flex;justify-content:space-between;align-items:center;
            padding:5px 0;border-bottom:1px dashed rgba(55,65,81,0.8);
            font-size:13px;
        }
        .list-item:last-child{border-bottom:none;}
        .badge{
            padding:2px 8px;border-radius:999px;font-size:11px;
            text-transform:uppercase;letter-spacing:.5px;
        }
        .badge-1{background:rgba(239,68,68,0.15);color:#fca5a5;}
        .badge-2{background:rgba(59,130,246,0.15);color:#bfdbfe;}
        .badge-3{background:rgba(34,197,94,0.15);color:#bbf7d0;}

        /* OVERLAY 3,2,1, GO */
        #countdownOverlay{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.92);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:999;
        }
        #countdownText{
            font-size:6rem;
            font-weight:800;
            letter-spacing:4px;
            text-transform:uppercase;
            text-shadow:0 0 25px rgba(248,250,252,0.8);
            animation:pulse 0.9s ease-in-out infinite;
        }
        @keyframes pulse{
            0%{transform:scale(1);}
            50%{transform:scale(1.15);}
            100%{transform:scale(1);}
        }
    </style>
</head>
<body>
<header>
    <div class="logo-area">
        <div class="logo-circle">
            <img src="logo-fds3.png" alt="FDS3">
        </div>
        <div class="logo-text">
            <strong>F√≥rmula DS3</strong>
            <span>Painel da corrida</span>
        </div>
    </div>
    <nav>
        <span class="user-info" id="infoUser"></span>
        <a href="recepcao.html">Recep√ß√£o</a>
        <a href="index.html" onclick="localStorage.removeItem('usuarioLogado')">Sair</a>
    </nav>
</header>

<!-- Overlay de contagem -->
<div id="countdownOverlay">
    <div id="countdownText">3</div>
</div>

<main>
    <div class="grid">
        <!-- LADO ESQUERDO: PISTA -->
        <section class="card">
            <div class="card-header">
                <div>
                    <span class="tag">Simula√ß√£o em tempo real</span>
                    <h2>Corrida Virtual FDS3 (Vertical)</h2>
                </div>
            </div>

            <div class="controls">
                <div class="buttons">
                    <button id="btnIniciar" class="btn btn-primary">‚ñ∂ Iniciar corrida</button>
                    <button id="btnReiniciar" class="btn btn-secondary" disabled>‚Ü∫ Reiniciar</button>
                </div>
                <p class="status">Status: <span id="statusTexto">Aguardando in√≠cio...</span></p>
            </div>

            <div class="track-wrapper">
                <div class="track" id="track">
                    <div class="finish-bar"></div>

                    <!-- Pista 1 -->
                    <div class="lane" id="lane1">
                        <div class="obstacle obstacle-1"></div>
                        <div class="obstacle obstacle-3"></div>

                        <div class="car-label">
                            <div class="car-dot car1"></div>
                            Carro 1
                        </div>
                        <div id="car1" class="car">
                            <img src="FDS3 1.png" alt="Carro 1" class="car-img">
                        </div>
                    </div>

                    <!-- Pista 2 -->
                    <div class="lane" id="lane2">
                        <div class="obstacle obstacle-2"></div>

                        <div class="car-label">
                            <div class="car-dot car2"></div>
                            Carro 2
                        </div>
                        <div id="car2" class="car">
                            <img src="FDS3 2.png" alt="Carro 2" class="car-img">
                        </div>
                    </div>

                    <!-- Pista 3 -->
                    <div class="lane" id="lane3">
                        <div class="obstacle obstacle-1"></div>
                        <div class="obstacle obstacle-2"></div>

                        <div class="car-label">
                            <div class="car-dot car3"></div>
                            Carro 3
                        </div>
                        <div id="car3" class="car">
                            <img src="FDS3 3.png" alt="Carro 3" class="car-img">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- LADO DIREITO: PAINEL -->
        <aside class="card">
            <div class="card-header">
                <div>
                    <span class="tag">Dados do Firebase</span>
                    <h2>Resumo de palpites e corridas</h2>
                </div>
            </div>

            <div class="mini-grid">
                <div class="pill">
                    <span>Palpites no Carro 1</span>
                    <span id="apC1" class="value">0</span>
                </div>
                <div class="pill">
                    <span>Palpites no Carro 2</span>
                    <span id="apC2" class="value">0</span>
                </div>
                <div class="pill">
                    <span>Palpites no Carro 3</span>
                    <span id="apC3" class="value">0</span>
                </div>
                <div class="pill">
                    <span>Total de corridas</span>
                    <span id="totalCorridas" class="value">0</span>
                </div>
            </div>

            <div class="mini-grid">
                <div class="pill">
                    <span>Vit√≥rias Carro 1</span>
                    <span id="vCarro1" class="value">0</span>
                </div>
                <div class="pill">
                    <span>Vit√≥rias Carro 2</span>
                    <span id="vCarro2" class="value">0</span>
                </div>
                <div class="pill">
                    <span>Vit√≥rias Carro 3</span>
                    <span id="vCarro3" class="value">0</span>
                </div>
            </div>

            <div class="winner-box" id="boxVencedor">
                Nenhuma corrida realizada ainda. Clique em <strong>‚ÄúIniciar corrida‚Äù</strong>.
            </div>

            <div class="list" id="listaApostas"></div>
        </aside>
    </div>
</main>

<script type="module">
    // Permite: corrida, admin, master
    const userData = localStorage.getItem("usuarioLogado");
    if(!userData){
        alert("Fa√ßa login primeiro.");
        window.location.href = "index.html";
    }else{
        const u = JSON.parse(userData);
        if(u.role !== "corrida" && u.role !== "admin" && u.role !== "master"){
            alert("Voc√™ n√£o tem acesso √† p√°gina da corrida.");
            window.location.href = "index.html";
        }else{
            const info =
                u.role === "master" ? "(MASTER)" :
                u.role === "admin"  ? "(ADMIN)"  :
                                      "(CORRIDA)";
            document.getElementById("infoUser").textContent =
                `Logado como: ${u.email} ${info}`;
        }
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, onValue, get, set, push } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
      authDomain: "eeba-9dfd0.firebaseapp.com",
      databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
      projectId: "eeba-9dfd0",
      storageBucket: "eeba-9dfd0.firebasestorage.app",
      messagingSenderId: "947616785928",
      appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const apostasRef  = ref(db,"apostas");
    const statsRef    = ref(db,"statsCorrida");
    const corridasRef = ref(db,"corridas");

    // Elementos
    const btnIniciar   = document.getElementById("btnIniciar");
    const btnReiniciar = document.getElementById("btnReiniciar");
    const statusTexto  = document.getElementById("statusTexto");
    const boxVencedor  = document.getElementById("boxVencedor");
    const trackEl      = document.getElementById("track");

    const apC1Span = document.getElementById("apC1");
    const apC2Span = document.getElementById("apC2");
    const apC3Span = document.getElementById("apC3");
    const totalCorridasSpan = document.getElementById("totalCorridas");
    const v1Span = document.getElementById("vCarro1");
    const v2Span = document.getElementById("vCarro2");
    const v3Span = document.getElementById("vCarro3");
    const listaApostas = document.getElementById("listaApostas");

    const countdownOverlay = document.getElementById("countdownOverlay");
    const countdownText    = document.getElementById("countdownText");

    // Config dos carros
    const cars = [
        { id:"car1", laneId:"lane1", nome:"Carro 1 ‚Ä¢ Silver Arrow", progresso:0 },
        { id:"car2", laneId:"lane2", nome:"Carro 2 ‚Ä¢ Orange Blaze", progresso:0 },
        { id:"car3", laneId:"lane3", nome:"Carro 3 ‚Ä¢ Red Scuderia", progresso:0 }
    ];
    let corridaAtiva = false;
    let intervalo    = null;
    const maxProgresso = 100;

    function atualizarPosicaoCarro(c){
        const laneEl = document.getElementById(c.laneId);
        const carEl  = document.getElementById(c.id);
        const laneHeight = laneEl.clientHeight;
        const carHeight  = carEl.clientHeight;

        const minBottom = 10;
        const maxBottom = laneHeight - carHeight - 12;

        const bottomPx = minBottom + (c.progresso/100) * (maxBottom - minBottom);
        carEl.style.bottom = `${bottomPx}px`;
    }

    function resetCars(){
        cars.forEach(c => {
            c.progresso = 0;
            atualizarPosicaoCarro(c);
            const el = document.getElementById(c.id);
            el.classList.remove("winner");
        });
        trackEl.classList.remove("running");
        statusTexto.textContent = "Aguardando in√≠cio...";
        boxVencedor.innerHTML = 'Nenhuma corrida realizada ainda. Clique em <strong>‚ÄúIniciar corrida‚Äù</strong>.';
    }

    function iniciarCorrida(){
        if(corridaAtiva) return;

        corridaAtiva = true;
        btnIniciar.disabled   = true;
        btnReiniciar.disabled = true;

        cars.forEach(c=>{
            c.progresso = 0;
            atualizarPosicaoCarro(c);
            document.getElementById(c.id).classList.remove("winner");
        });

        let contador = 3;
        countdownText.textContent = "3";
        countdownOverlay.style.display = "flex";
        statusTexto.textContent = "Preparar...";
        trackEl.classList.remove("running");

        const timer = setInterval(()=>{
            contador--;
            if(contador === 2){
                countdownText.textContent = "2";
            }else if(contador === 1){
                countdownText.textContent = "1";
            }else if(contador === 0){
                countdownText.textContent = "GO!";
                statusTexto.textContent = "Corrida em andamento...";
            }else{
                clearInterval(timer);
                countdownOverlay.style.display = "none";
                trackEl.classList.add("running");
                iniciarMovimentoCarros();
            }
        },1000);
    }

    function iniciarMovimentoCarros(){
        intervalo = setInterval(() => {
            cars.forEach(c => {
                const incremento = Math.random()*4 + 1; // 1 a 5
                c.progresso += incremento;
                if(c.progresso > maxProgresso){
                    c.progresso = maxProgresso;
                }
                atualizarPosicaoCarro(c);
            });

            const chegados = cars.filter(c=>c.progresso >= maxProgresso);
            if(chegados.length > 0){
                const maior = Math.max(...chegados.map(c=>c.progresso));
                const candidatos = chegados.filter(c=>c.progresso === maior);
                const vencedor = candidatos[Math.floor(Math.random()*candidatos.length)];
                encerrarCorrida(vencedor);
            }
        },80);
    }

    async function encerrarCorrida(vencedor){
        clearInterval(intervalo);
        corridaAtiva = false;
        trackEl.classList.remove("running");

        const elVencedor = document.getElementById(vencedor.id);
        elVencedor.classList.add("winner");

        const nomeCurto = vencedor.id === "car1" ? "Carro 1"
                        : vencedor.id === "car2" ? "Carro 2"
                        : "Carro 3";

        statusTexto.textContent = `Corrida finalizada! Vencedor: ${nomeCurto}`;
        boxVencedor.innerHTML = `<strong>${nomeCurto}</strong> venceu essa bateria! Resultado salvo no Firebase. üèÅ`;

        btnIniciar.disabled   = false;
        btnReiniciar.disabled = false;

        await registrarVencedorNoFirebase(vencedor.id);
    }

    async function registrarVencedorNoFirebase(idCarro){
        try{
            const snap = await get(statsRef);
            const dadosAtuais = snap.exists()
                ? snap.val()
                : { totalCorridas:0, vitoriasCarro1:0, vitoriasCarro2:0, vitoriasCarro3:0 };

            dadosAtuais.totalCorridas++;

            if(idCarro === "car1") dadosAtuais.vitoriasCarro1++;
            if(idCarro === "car2") dadosAtuais.vitoriasCarro2++;
            if(idCarro === "car3") dadosAtuais.vitoriasCarro3++;

            await set(statsRef, dadosAtuais);

            await push(corridasRef,{
                vencedor:idCarro,
                dataHora:new Date().toISOString()
            });
        }catch(err){
            console.error("Erro ao salvar no Firebase:",err);
        }
    }

    // Estat√≠sticas de corridas
    onValue(statsRef,(snapshot)=>{
        if(snapshot.exists()){
            const s = snapshot.val();
            totalCorridasSpan.textContent = s.totalCorridas  ?? 0;
            v1Span.textContent            = s.vitoriasCarro1 ?? 0;
            v2Span.textContent            = s.vitoriasCarro2 ?? 0;
            v3Span.textContent            = s.vitoriasCarro3 ?? 0;
        }else{
            totalCorridasSpan.textContent = 0;
            v1Span.textContent = v2Span.textContent = v3Span.textContent = 0;
        }
    });

    // Palpites
    onValue(apostasRef,(snapshot)=>{
        let c1=0,c2=0,c3=0;
        const lista = [];
        if(snapshot.exists()){
            snapshot.forEach(child=>{
                const v = child.val();
                if(v.carro === "carro1") c1++;
                if(v.carro === "carro2") c2++;
                if(v.carro === "carro3") c3++;
                lista.push(v);
            });
        }
        apC1Span.textContent = c1;
        apC2Span.textContent = c2;
        apC3Span.textContent = c3;

        listaApostas.innerHTML = "";
        const ultimas = lista.slice(-8).reverse();
        if(ultimas.length === 0){
            listaApostas.innerHTML = "<p style='font-size:12px;color:var(--muted);'>Nenhum palpite cadastrado ainda.</p>";
        }else{
            ultimas.forEach(v=>{
                const div = document.createElement("div");
                div.className = "list-item";
                const s1 = document.createElement("span");
                s1.textContent = `${v.nome} ‚Ä¢ ${v.turma}`;
                const badge = document.createElement("span");
                let cls="badge-1", txt="Carro 1";
                if(v.carro==="carro2"){cls="badge-2";txt="Carro 2";}
                if(v.carro==="carro3"){cls="badge-3";txt="Carro 3";}
                badge.className="badge "+cls;
                badge.textContent=txt;
                div.appendChild(s1);
                div.appendChild(badge);
                listaApostas.appendChild(div);
            });
        }
    });

    btnIniciar.addEventListener("click",iniciarCorrida);
    btnReiniciar.addEventListener("click",resetCars);
    resetCars();
</script>
</body>
</html>
