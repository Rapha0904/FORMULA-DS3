<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Recepção - Cadastro & Palpite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{--bg:#020617;--card:#020617;--text:#f9fafb;--muted:#9ca3af;--accent:#ef4444;--accent-soft:#f97316}
        *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
        body{min-height:100vh;background:radial-gradient(circle at top,#1f2937,#020617);color:var(--text);padding-top:64px;}
        header{position:fixed;top:0;left:0;right:0;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid rgba(148,163,184,0.35);background:rgba(2,6,23,0.95);z-index:50}
        .brand{display:flex;align-items:center;gap:10px}
        .logo-circle{width:48px;height:48px;border-radius:8px;background:#fff;padding:6px;display:flex;align-items:center;justify-content:center}
        .logo-circle img{width:36px}
        .menu-toggle{display:none;border:none;background:transparent;color:var(--text);font-size:20px;padding:8px;border-radius:8px;cursor:pointer}
        nav{display:flex;align-items:center;gap:8px}
        nav a{font-size:12px;color:#93c5fd;text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid rgba(147,197,253,0.7)}
        .user-info{font-size:12px;color:var(--muted)}
        main{max-width:900px;margin:16px auto;padding:12px}
        .card{background:radial-gradient(circle at top,#020617,#020617 40%,#030712);border-radius:20px;padding:18px 16px 22px;border:1px solid rgba(148,163,184,0.45);box-shadow:0 20px 40px rgba(0,0,0,0.75)}
        .tag{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
        h2{font-size:19px}
        .description{font-size:12px;color:var(--muted);margin-top:4px}
        .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:14px}
        @media(max-width:700px){.form-grid{grid-template-columns:1fr}}
        .form-group{display:flex;flex-direction:column;gap:5px;font-size:13px}
        label{color:var(--muted);font-weight:500}
        input, select{padding:9px 11px;border-radius:12px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.9);color:var(--text);font-size:13px;transition:border .15s, box-shadow .15s, background .15s;width:100%}
        .actions{margin-top:16px;display:flex;justify-content:flex-end}
        .btn{padding:9px 20px;border-radius:999px;border:none;background:linear-gradient(135deg,#f97316,#ef4444);color:white;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.6px;cursor:pointer}
        #msgCadastro{margin-top:10px;font-size:12px}
        .ok{color:#4ade80}
        .erro{color:#fca5a5}

        /* hide helper class */
        .hidden { display:none !important; }

        /* mobile nav */
        @media(max-width:900px){
            nav{position:fixed;top:64px;right:12px;background:linear-gradient(180deg, rgba(2,6,23,0.98), rgba(2,6,23,0.95));padding:12px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.6);display:none;flex-direction:column;gap:8px;z-index:60}
            nav.open{display:flex}
            .menu-toggle{display:inline-flex}
        }
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="logo-circle"><img src="logo-fds3.png" alt="FDS3"></div>
        <div>
            <strong>Fórmula DS3</strong><br>
            <span id="infoUser">Recepção • Cadastro & palpite</span>
        </div>
    </div>

    <div>
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">☰</button>
        <nav id="mainNav">
            <span class="user-info" id="infoUserNav"></span>
            <a href="dashboard.html">Dashboard</a>
            <a href="consulta_entradas.html">Consultar entradas</a>
            <a href="admin.html">Admin</a>
            <a href="corrida.html">Corrida</a>
            <a href="index.html" id="logoutBtn">Sair</a>
        </nav>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-header">
            <span class="tag">Entrada de participantes</span>
            <h2>Cadastro + escolha de palpite</h2>
            <p class="description">A recepção registra quem está entrando no evento e já define em qual carrinho a pessoa está dando o palpite.</p>
        </div>

        <form id="formCadastro" autocomplete="off">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nome">Nome completo</label>
                    <input id="nome" type="text" placeholder="Ex: Raphael Santos" required>
                </div>

                <div class="form-group" id="group-serie">
                    <label for="serie">Série</label>
                    <select id="serie">
                        <option value="">Selecione...</option>
                        <option value="9º Ano">9º Ano</option>
                        <option value="1º Ano">1º Ano</option>
                        <option value="2º Ano">2º Ano</option>
                        <option value="3º Ano">3º Ano</option>
                    </select>
                </div>

                <div class="form-group" id="group-turma">
                    <label for="turma">Turma</label>
                    <select id="turma">
                        <option value="">Selecione...</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                    </select>
                </div>

                <div class="form-group" id="group-categoria">
                    <label for="categoria">Categoria</label>
                    <select id="categoria">
                        <option value="">Selecione...</option>
                        <option value="REG">REG</option>
                        <option value="ADM">ADM</option>
                        <option value="ADS">ADS</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo</label>
                    <select id="tipo" required>
                        <option value="">Selecione...</option>
                        <option value="Visitante">Visitante</option>
                        <option value="Avaliador">Avaliador</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="carro">Carrinho escolhido (palpite)</label>
                    <select id="carro" required>
                        <option value="">Selecione...</option>
                        <option value="carro1">Carro 1 • Ferrari</option>
                        <option value="carro2">Carro 2 • MCLaren</option>
                        <option value="carro3">Carro 3 • Mercedes</option>
                    </select>
                </div>
            </div>

            <div class="actions">
                <button class="btn" type="submit">Registrar entrada</button>
            </div>
            <div id="msgCadastro"></div>
        </form>
    </section>
</main>

<script type="module">
    // NAV hamburger
    const menuToggle = document.getElementById('menuToggle');
    const mainNav = document.getElementById('mainNav');
    menuToggle.addEventListener('click', ()=> mainNav.classList.toggle('open'));
    document.addEventListener('click', (e)=>{
        if(window.innerWidth <= 900 && !e.target.closest('header')) mainNav.classList.remove('open');
    });

    // Permissões (não redireciona automaticamente — mostra overlay)
    const userData = localStorage.getItem("usuarioLogado");
    if(!userData){
        alert("Faça login primeiro.");
        window.location.href = "index.html";
    }else{
        const u = JSON.parse(userData);
        // atualizar exibição do usuário no header/nav
        document.getElementById("infoUser").textContent = `Logado como: ${u.email}`;
        const infoNav = document.getElementById("infoUserNav");
        if(infoNav) infoNav.textContent = `Logado como: ${u.email} (${u.role || ""})`;

        if(u.role !== "recepcao" && u.role !== "admin" && u.role !== "master"){
            // overlay bloqueio sem redirecionamento
            const overlay = document.createElement('div');
            overlay.id = 'accessBlocked';
            Object.assign(overlay.style, {position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'linear-gradient(90deg, rgba(2,6,23,0.85), rgba(2,6,23,0.95))',zIndex:9999});
            overlay.innerHTML = `<div style="max-width:720px;width:90%;background:linear-gradient(135deg,#0b1220,#021024);padding:22px;border-radius:12px;text-align:center;color:var(--text)">
                <h2 style="color:#fca5a5">Acesso bloqueado</h2>
                <p style="color:var(--muted)">Solicite ao administrador alteração de perfil.</p>
                <button id="reqAdminBtn" style="padding:10px 14px;border-radius:999px;border:none;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff">Solicitar alteração</button>
            </div>`;
            document.body.appendChild(overlay);
            // bloquear inputs/botoes
            document.querySelectorAll('button,input,select,textarea').forEach(el=>el.disabled=true);
            // manter logout disabled também (conforme sua requisição anterior) — mas se quiser permitir logout, comente a linha abaixo
            document.getElementById('logoutBtn').disabled = true;

            document.getElementById('reqAdminBtn').addEventListener('click', ()=> {
                window.location.href = "mailto:rh@empresa.com.br?subject=Solicitação%20de%20alteração%20de%20perfil&body=Por%20favor%20alterar%20meu%20perfil.%20Email:%20" + encodeURIComponent(u.email || '');
            });
        }
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("usuarioLogado");
        setTimeout(()=> window.location.href = "index.html", 50);
    });

    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
      authDomain: "eeba-9dfd0.firebaseapp.com",
      databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
      projectId: "eeba-9dfd0",
      storageBucket: "eeba-9dfd0.firebasestorage.app",
      messagingSenderId: "947616785928",
      appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const apostasRef = ref(db, "apostas");

    const formCadastro = document.getElementById("formCadastro");
    const msgCadastro  = document.getElementById("msgCadastro");

    // helpers para exibir/ocultar campos conforme tipo
    const tipoSelect = document.getElementById("tipo");
    const groupSerie = document.getElementById("group-serie");
    const groupTurma = document.getElementById("group-turma");
    const groupCategoria = document.getElementById("group-categoria");
    const serieInput = document.getElementById("serie");
    const turmaInput = document.getElementById("turma");
    const categoriaSelect = document.getElementById("categoria");

    function setFieldsForAvaliador(on){
        if(on){
            // ocultar e desabilitar série/turma; categoria -> OUTROS
            groupSerie.classList.add('hidden');
            groupTurma.classList.add('hidden');
            serieInput.value = "";
            turmaInput.value = "";
            serieInput.disabled = true;
            turmaInput.disabled = true;
            categoriaSelect.value = "OUTROS";
            categoriaSelect.disabled = true;
        }else{
            groupSerie.classList.remove('hidden');
            groupTurma.classList.remove('hidden');
            serieInput.disabled = false;
            turmaInput.disabled = false;
            categoriaSelect.disabled = false;
        }
    }

    // inicializa de acordo com o valor atual (caso reabra)
    setFieldsForAvaliador(tipoSelect.value === "Avaliador");

    tipoSelect.addEventListener("change", (e)=>{
        setFieldsForAvaliador(e.target.value === "Avaliador");
    });

    formCadastro.addEventListener("submit", async (e) => {
        e.preventDefault();
        msgCadastro.textContent = "";
        msgCadastro.className = "";

        const nome      = document.getElementById("nome").value.trim();
        const serie     = document.getElementById("serie").value;
        const turma     = document.getElementById("turma").value;
        const categoria = document.getElementById("categoria").value;
        const tipo      = document.getElementById("tipo").value;
        const carro     = document.getElementById("carro").value;

        // validações: nome, tipo e carro sempre obrigatórios
        if(!nome || !tipo || !carro){
            msgCadastro.textContent = "Preencha os campos obrigatórios (Nome, Tipo e Carrinho).";
            msgCadastro.className = "erro";
            return;
        }

        // se não for avaliador, série/turma/categoria devem ser preenchidos
        if(tipo !== "Avaliador" && (!serie || !turma || !categoria)){
            msgCadastro.textContent = "Preencha todos os campos (série, turma, categoria).";
            msgCadastro.className = "erro";
            return;
        }

        // montar objeto com campos compatíveis com consulta_entradas.html
        const nowIso = new Date().toISOString();
        const novaAposta = {
            nome,
            serie: (tipo === "Avaliador") ? "" : serie,
            turma: (tipo === "Avaliador") ? "" : turma,
            categoria: (tipo === "Avaliador") ? "OUTROS" : categoria,
            tipo,
            carro,
            // campos para consulta e controles
            dataHora: nowIso,            // usado em consulta (dataHora)
            horaEntrada: nowIso,        // compatibilidade com versão anterior
            statusPresenca: "presente",
            saidaHora: "",
            tempoSegundos: 0,
            tempoFormatado: "",
            lembrancinha: false
        };

        try{
            await push(apostasRef, novaAposta);
            msgCadastro.textContent = "Entrada registrada e palpite salvo!";
            msgCadastro.className = "ok";
            formCadastro.reset();
            // restaurar campos habilitados (se o usuário voltou a escolher Visitante)
            setFieldsForAvaliador(false);
        }catch(err){
            console.error(err);
            msgCadastro.textContent = "Erro ao salvar no Firebase.";
            msgCadastro.className = "erro";
        }
    });
</script>
</body>
</html>
