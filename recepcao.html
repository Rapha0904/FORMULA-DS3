<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Recepção - Cadastro & Palpite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root{
            --bg:#020617;
            --card:#020617;
            --text:#f9fafb;
            --muted:#9ca3af;
            --accent:#ef4444;
            --accent-soft:#f97316;
            --green:#16a34a;
            --red:#ef4444;
            --gray:#6b7280;
        }
        *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui;}
        body{min-height:100vh;background:radial-gradient(circle at top,#1f2937,#020617);color:var(--text);}
        header{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid rgba(148,163,184,0.35);background:rgba(2,6,23,0.95);backdrop-filter:blur(10px);}
        .brand{display:flex;align-items:center;gap:12px;}
        .logo-circle{width:44px;height:44px;border-radius:8px;overflow:hidden;background:#fff;padding:4px}
        .logo-circle img{width:36px;height:36px;object-fit:contain}
        nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        nav a{font-size:13px;color:#93c5fd;text-decoration:none;padding:6px 10px;border-radius:999px;border:1px solid rgba(147,197,253,0.7);}
        nav a:hover{background:rgba(37,99,235,0.12);}
        .user-info{font-size:12px;color:var(--muted);margin-right:8px;}
        main{max-width:980px;margin:18px auto;padding:0 12px;}
        .card{background:radial-gradient(circle at top,#020617,#020617 40%,#030712);border-radius:12px;padding:18px;border:1px solid rgba(148,163,184,0.15);box-shadow:0 14px 28px rgba(0,0,0,0.6);}
        h2{font-size:20px;margin-bottom:6px}
        .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
        @media(max-width:760px){.form-grid{grid-template-columns:1fr}}
        .form-group{display:flex;flex-direction:column;gap:6px}
        input,select{padding:10px;border-radius:10px;border:1px solid rgba(148,163,184,0.12);background:rgba(10,16,26,0.7);color:var(--text)}
        .actions{display:flex;justify-content:flex-end;margin-top:16px}
        .btn{padding:10px 18px;border-radius:999px;border:none;background:linear-gradient(135deg,#f97316,#ef4444);color:white;cursor:pointer}
        .note{font-size:13px;color:var(--muted);margin-top:6px}
        .hidden{display:none!important}
        /* small feedback messages */
        .ok{color:#4ade80}
        .erro{color:#fca5a5}
    </style>
</head>
<body>
<header>
    <div class="brand">
        <div class="logo-circle"><img src="logo-fds3.png" alt="FDS3"></div>
        <div>
            <strong>Fórmula DS3</strong><br>
            <span class="user-info" id="infoUser"></span>
        </div>
    </div>
    <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="recepcao.html">Recepção</a>
        <a href="consulta_entradas.html">Consultar entradas</a>
        <a href="admin.html">Admin</a>
        <a href="corrida.html">Corrida</a>
        <a href="index.html" id="logoutBtn">Sair</a>
    </nav>
</header>

<main>
    <section class="card">
        <h2>Cadastro + escolha de palpite</h2>
        <p class="note">A recepção registra quem está entrando e salva o palpite no carro escolhido.</p>

        <form id="formCadastro" autocomplete="off">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nome">Nome completo</label>
                    <input id="nome" type="text" placeholder="Ex: Raphael Santos" required>
                </div>

                <div class="form-group serie-group">
                    <label for="serie">Série</label>
                    <select id="serie" required>
                        <option value="">Selecione...</option>
                        <option value="9º Ano">9º Ano</option>
                        <option value="1º Ano">1º Ano</option>
                        <option value="2º Ano">2º Ano</option>
                        <option value="3º Ano">3º Ano</option>
                    </select>
                </div>

                <div class="form-group turma-group">
                    <label for="turma">Turma</label>
                    <select id="turma" required>
                        <option value="">Selecione...</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                    </select>
                </div>

                <div class="form-group categoria-group">
                    <label for="categoria">Categoria</label>
                    <select id="categoria" required>
                        <option value="">Selecione...</option>
                        <option value="REG">REG</option>
                        <option value="ADM">ADM</option>
                        <option value="ADS">ADS</option>
                        <option value="OUTROS">OUTROS</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipo">Tipo</label>
                    <select id="tipo" required>
                        <option value="">Selecione...</option>
                        <option value="Visitante">Visitante</option>
                        <option value="Avaliador">Avaliador</option>
                    </select>
                    <div class="note">Se for Avaliador (professor), Série/Turma/Categoria serão escondidos.</div>
                </div>

                <div class="form-group">
                    <label for="carro">Carrinho escolhido (palpite)</label>
                    <select id="carro" required>
                        <option value="">Selecione...</option>
                        <option value="carro1">Carro 1 • Ferrari</option>
                        <option value="carro2">Carro 2 • MCLaren</option>
                        <option value="carro3">Carro 3 • Mercedes</option>
                    </select>
                </div>
            </div>

            <div class="actions">
                <button class="btn" type="submit">Registrar entrada</button>
            </div>
            <div id="msgCadastro" style="margin-top:10px;font-size:13px"></div>
        </form>
    </section>
</main>

<script type="module">
/* acesso */
const ALLOWED_ROLES = ["recepcao","admin","master"];
const infoUserEl = document.getElementById("infoUser");
const logoutBtn = document.getElementById("logoutBtn");
function getUser(){ try{ return JSON.parse(localStorage.getItem("usuarioLogado")); }catch(e){return null;} }
function showAccessBlocked(message){
    document.querySelectorAll("button,input,select,textarea").forEach(el=>el.disabled=true);
    if(logoutBtn) logoutBtn.disabled=true;
    if(document.getElementById("accessBlockedCard")) return;
    const card=document.createElement("div"); card.id="accessBlockedCard";
    Object.assign(card.style,{position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(90deg, rgba(2,6,23,0.8), rgba(2,6,23,0.95))",zIndex:"9999"});
    const inner=document.createElement("div"); Object.assign(inner.style,{maxWidth:"720px",width:"92%",borderRadius:"14px",padding:"22px",boxShadow:"0 20px 40px rgba(0,0,0,0.7)",background:"linear-gradient(135deg,#0b1220,#021024)",color:"var(--text)",textAlign:"center"});
    const title=document.createElement("h2"); title.textContent="Acesso bloqueado"; title.style.color="#fca5a5";
    const p=document.createElement("p"); p.textContent = message || "Solicite ao administrador alteração de perfil."; p.style.color="var(--muted)";
    const btn=document.createElement("button"); btn.textContent="Solicitar alteração ao administrador"; Object.assign(btn.style,{padding:"10px 16px",borderRadius:"999px",border:"none",cursor:"pointer",background:"linear-gradient(135deg,#f97316,#ef4444)",color:"#fff",fontWeight:"700"});
    btn.onclick = ()=> window.location.href = "mailto:rh@empresa.com.br?subject=Solicitação%20de%20alteração%20de%20perfil&body=Por%20favor%20alterar%20meu%20perfil.%20Email:%20" + encodeURIComponent(getUser()?.email || "");
    const btnClose=document.createElement("button"); btnClose.textContent="Fechar aviso"; Object.assign(btnClose.style,{marginLeft:"10px",padding:"10px 14px",borderRadius:"999px",border:"1px solid rgba(148,163,184,0.25)",background:"transparent",color:"var(--text)",cursor:"pointer"});
    btnClose.onclick = ()=> card.remove();
    inner.appendChild(title); inner.appendChild(p); inner.appendChild(btn); inner.appendChild(btnClose); card.appendChild(inner); document.body.appendChild(card);
}

(function checkAccess(){
    const u = getUser();
    if(!u){ showAccessBlocked("Faça login para acessar esta página."); infoUserEl.textContent = ""; return; }
    if(!ALLOWED_ROLES.includes(u.role)){ showAccessBlocked("Acesso bloqueado — solicite ao administrador alteração de perfil."); infoUserEl.textContent = `Logado como: ${u.email} (${u.role})`; return; }
    infoUserEl.textContent = `Logado como: ${u.email} ${u.role === "master" ? "(MASTER)" : u.role === "admin" ? "(ADMIN)" : "(RECEPÇÃO)"}`;
})();

if(logoutBtn) logoutBtn.addEventListener("click", ()=>{ localStorage.removeItem("usuarioLogado"); setTimeout(()=>window.location.href="index.html",50); });

/* firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAmm8PRi_1OJoufaSBCooGb4cQ3HQZGT0o",
  authDomain: "eeba-9dfd0.firebaseapp.com",
  databaseURL: "https://eeba-9dfd0-default-rtdb.firebaseio.com",
  projectId: "eeba-9dfd0",
  storageBucket: "eeba-9dfd0.firebasestorage.app",
  messagingSenderId: "947616785928",
  appId: "1:947616785928:web:37b39b183bbd1acc9813bd"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const apostasRef = ref(db, "apostas");

const formCadastro = document.getElementById("formCadastro");
const msgCadastro  = document.getElementById("msgCadastro");

const tipoSelect = document.getElementById("tipo");
const serieGroup = document.querySelector(".serie-group");
const turmaGroup = document.querySelector(".turma-group");
const categoriaGroup = document.querySelector(".categoria-group");

function ajustarCamposPorTipo(tipo){
    if(tipo === "Avaliador"){
        serieGroup.classList.add("hidden");
        turmaGroup.classList.add("hidden");
        categoriaGroup.classList.add("hidden");
        document.getElementById("serie").required = false;
        document.getElementById("turma").required = false;
        document.getElementById("categoria").required = false;
        document.getElementById("serie").value = "";
        document.getElementById("turma").value = "";
        document.getElementById("categoria").value = "";
    }else{
        serieGroup.classList.remove("hidden");
        turmaGroup.classList.remove("hidden");
        categoriaGroup.classList.remove("hidden");
        document.getElementById("serie").required = true;
        document.getElementById("turma").required = true;
        document.getElementById("categoria").required = true;
    }
}
ajustarCamposPorTipo(tipoSelect.value);
tipoSelect.addEventListener("change",(e)=> ajustarCamposPorTipo(e.target.value));

formCadastro.addEventListener("submit", async (e)=>{
    e.preventDefault();
    msgCadastro.textContent = "";
    msgCadastro.className = "";

    const nome      = document.getElementById("nome").value.trim();
    const serie     = document.getElementById("serie").value;
    const turma     = document.getElementById("turma").value;
    const categoria = document.getElementById("categoria").value;
    const tipo      = document.getElementById("tipo").value;
    const carro     = document.getElementById("carro").value;

    if(!nome || !tipo || !carro){
        msgCadastro.textContent = "Preencha nome, tipo e carrinho.";
        msgCadastro.className = "erro";
        return;
    }
    if(tipo !== "Avaliador" && (!serie || !turma || !categoria)){
        msgCadastro.textContent = "Para Visitante, preencha série, turma e categoria.";
        msgCadastro.className = "erro";
        return;
    }

    const novaAposta = {
        nome,
        serie: tipo === "Avaliador" ? "" : serie,
        turma: tipo === "Avaliador" ? "" : turma,
        categoria: tipo === "Avaliador" ? "" : categoria,
        tipo,
        carro,
        dataHora: new Date().toISOString(),
        statusPresenca: "presente",   // default presente
        lembrancinha: false,          // default não recebeu lembrancinha
        saidaHora: "",                // será preenchido quando marcar ausente
        tempoSegundos: 0,
        tempoFormatado: ""
    };

    try{
        await push(apostasRef, novaAposta);
        msgCadastro.textContent = "Entrada registrada e palpite salvo!";
        msgCadastro.className = "ok";
        formCadastro.reset();
        ajustarCamposPorTipo(document.getElementById("tipo").value);
    }catch(err){
        console.error(err);
        msgCadastro.textContent = "Erro ao salvar no Firebase.";
        msgCadastro.className = "erro";
    }
});
</script>
</body>
</html>
